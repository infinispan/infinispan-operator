language: go

go:
  - '1.13.x'

dist: focal
os: linux

before_install:
  - |
    if [ "$TRAVIS_PULL_REQUEST" != "false" ] ; then
      git fetch origin $TRAVIS_BRANCH
      git diff --name-only FETCH_HEAD | grep -qvE '(\.md$)|(^(doc|documentation|manual|olm|ci|deploy/cr/|deploy/olm-catalog|build/cekit|build/jenkins|build/minikube|test-integration|.gitignore))/' || {
        set -e
        echo "Only docs, manual steps, test-integration,CI and OLM files were updated, stopping build process."
        travis_terminate 0
        exit 1
      }
    fi


jobs:
  include:
    - stage: "Unit Test and Go linters (golangci-lint) run"
      name: "Unit Test"
      arch: arm64
      virt: lxd
      before_script:
        - export GO111MODULE=on
      script:
        - go mod vendor
        - make unit-test
        - make lint
    # set yaml anchors and alias for stage
    - &core_tests
      stage: "Core and Multi-namespace tests"
      services:
        - docker
      # set yaml anchors and alias for node environment
      env: &kind_node_1_17
        - KIND_VERSION=v0.11.0
        - KIND_NODE_VERSION="v.1.17.17@sha256:596ab0698618c429a57be66e712deac68c819a872fa8816d0195cfd691717c70"
        - OSDK_FORCE_RUN_MODE=local
        - METALLB_VERSION=v0.9.6
      before_script:
        - source ./build/travis/configure-travis-ci.sh
        - go mod vendor
      script:
        # Run multinamespace tests as admin (skip role settings check)
        - make test PARALLEL_COUNT=2 && make batch-test PARALLEL_COUNT=2 && kubectl config use-context $TESTING_CONTEXT && make multinamespace-test
      after_failure:
        - cat debug.log
        - kubectl config use-context $TESTING_CONTEXT
        - kubectl get events --all-namespaces
        - kubectl cluster-info
        - df -h
        - docker ps -a
        - for log in $(docker ps -qa | xargs); do docker logs --tail 500 $log; done

    - &backup_tests
      stage: "Backup/Restore tests"
      services:
        - docker
      env: *kind_node_1_17
      before_script:
        - source ./build/travis/configure-travis-ci.sh
        - go mod vendor
      script:
        - make backuprestore-test
      after_failure:
        - cat debug.log
        - kubectl config use-context $TESTING_CONTEXT
        - kubectl get events --all-namespaces
        - kubectl cluster-info
        - df -h
        - docker ps -a
        - for log in $(docker ps -qa | xargs); do docker logs --tail 500 $log; done

    - &cross_site_scripts
      stage: "Cross-Site multiple clusters test"
      services:
        - docker
      env: *kind_node_1_17

      before_script:
        - sudo snap install yq
        - source build/travis/configure-travis-ci-xsite.sh
      script:
        - go test -v ./test/e2e/xsite/ -timeout 30m
      after_failure:
        - kubectl logs deployment/infinispan-operator -n namespace-for-testing-xsite1 --context kind-xsite1
        - kubectl logs deployment/infinispan-operator -n namespace-for-testing-xsite2 --context kind-xsite2
        - df -h
        - docker ps -a
        - for log in $(docker ps -qa | xargs); do docker logs --tail 500 $log; done


   # repeate tests for v1.16 kind node
    - <<: *core_tests
      env: &kind_node_1_16
        - KIND_VERSION=v0.11.0
        - KIND_NODE_VERSION="v1.16.15@sha256:a89c771f7de234e6547d43695c7ab047809ffc71a0c3b65aa54eda051c45ed20"
        - OSDK_FORCE_RUN_MODE=local
        - METALLB_VERSION=v0.9.6

    - <<: *cross_site_scripts
      env: *kind_node_1_16

    - <<: *backup_tests
      env: *kind_node_1_16
